= TYPO3 CMS =

Erstelle eine neue SQLite3-Datenbank mit PHP:

<syntaxhighlight lang="bash">
sudo apt-get install php-sqlite3
sudo systemctl restart nginx
</syntaxhighlight>

Oder erstelle eine neue PostgreSQL-Datenbank:

<syntaxhighlight lang="bash">
sudo -u postgres -i
createdb -E UTF8 -O thorsten typo3
exit
</syntaxhighlight>

== Herunterladen und Installieren ==

Lade das Repository herunter und installiere die Abhängigkeiten:

<syntaxhighlight lang="bash">
git clone https://github.com/thorstenkloehn/typo3.git
sudo chown -R www-data:www-data /var/www/typo3
find typo3 -type d -exec chmod 755 {} \;
find typo3 -type f -exec chmod 644 {} \;
</syntaxhighlight>

Erstelle die folgende nginx-Konfigurationsdatei:

<syntaxhighlight lang="bash">
sudo nano /etc/nginx/conf.d/typo3.conf
</syntaxhighlight>

Füge folgendes ein:
<syntaxhighlight lang="nginx">
server {
    listen 80;
    server_name typo3.localhost;
    root /var/www/typo3/public;

    index index.php index.html;

#    include /etc/nginx/conf.d/nginx.conf;

    location ~ \.js\.gzip$ {
        add_header Content-Encoding gzip;
        gzip off;
        types { text/javascript gzip; }
    }
    location ~ \.css\.gzip$ {
        add_header Content-Encoding gzip;
        gzip off;
        types { text/css gzip; }
    }

    if (!-e $request_filename) {
        rewrite ^/(.+)\.(\d+)\.(php|js|css|png|jpg|gif|gzip)$ /$1.$3 last;
    }

    location ~* composer\.(?:json|lock) {
        deny all;
    }
    location ~* flexform[^.]*\.xml {
        deny all;
    }
    location ~* locallang[^.]*\.(?:xml|xlf)$ {
        deny all;
    }
    location ~* ext_conf_template\.txt|ext_typoscript_constants\.txt|ext_typoscript_setup\.txt {
        deny all;
    }
    location ~* /.*\.(?:bak|co?nf|cfg|ya?ml|ts|typoscript|tsconfig|dist|fla|in[ci]|log|sh|sql|sqlite)$ {
        deny all;
    }
    location ~ _(?:recycler|temp)_/ {
        deny all;
    }
    location ~ fileadmin/(?:templates)/.*\.(?:txt|ts|typoscript)$ {
        deny all;
    }
    location ~ ^(?:vendor|typo3_src|typo3temp/var) {
        deny all;
    }
    location ~ (?:typo3conf/ext|typo3/sysext|typo3/ext)/[^/]+/(?:Configuration|Resources/Private|Tests?|Documentation|docs?)/ {
        deny all;
    }

    location / {
        try_files $uri $uri/ /index.php$is_args$args;
    }
    location = /typo3 {
        rewrite ^ /typo3/;
    }
    location /typo3/ {
        absolute_redirect off;
        try_files $uri /typo3/index.php$is_args$args;
    }
    location ~ [^/]\.php(/|$) {
        fastcgi_split_path_info ^(.+?\.php)(/.*)$;
        if (!-f $document_root$fastcgi_script_name) {
            return 404;
        }
        fastcgi_buffer_size 32k;
        fastcgi_buffers 8 16k;
        fastcgi_connect_timeout 240s;
        fastcgi_read_timeout 240s;
        fastcgi_send_timeout 240s;

        include              snippets/fastcgi-php.conf;
        fastcgi_pass         unix:/var/run/php/php8.4-fpm.sock;
    }
}
</syntaxhighlight>

== Server übertragen ==

Um die TYPO3-Installation auf einen anderen Server zu übertragen, kannst du folgenden <code>rsync</code>-Befehl verwenden:

<syntaxhighlight lang="bash">
rsync -avz --exclude 'config/' \
  --exclude '.DS_Store' \
  --exclude '.idea/' \
  --exclude 'nbproject/' \
  --exclude 'var/' \
  --exclude 'vendor/' \
  --exclude 'public/' \
  --exclude '.git/' \
  --exclude '.gitignore' \
  /var/www/typo3/ user@server:/var/www/typo3/
</syntaxhighlight>

== Composer Ausführen ==

<syntaxhighlight lang="bash">
composer install --no-dev --optimize-autoloader
</syntaxhighlight>

Passe <code>user@server</code> entsprechend deiner Zielumgebung an. Weitere Ausschlüsse können je nach Bedarf ergänzt werden, z.B. für temporäre Dateien oder Backups.

Erstelle die folgende nginx-Konfigurationsdatei:

<syntaxhighlight lang="bash">
sudo nano /etc/nginx/conf.d/typo3.conf
</syntaxhighlight>

Füge folgendes ein:
<syntaxhighlight lang="nginx">
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name typo3.ahrensburg.city;
    ssl_certificate /etc/letsencrypt/live/ahrensburg.city/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ahrensburg.city/privkey.pem;
    server_name typo3.localhost;
    root /var/www/typo3/public;

    index index.php index.html;

#    include /etc/nginx/conf.d/nginx.conf;

    location ~ \.js\.gzip$ {
        add_header Content-Encoding gzip;
        gzip off;
        types { text/javascript gzip; }
    }
    location ~ \.css\.gzip$ {
        add_header Content-Encoding gzip;
        gzip off;
        types { text/css gzip; }
    }

    if (!-e $request_filename) {
        rewrite ^/(.+)\.(\d+)\.(php|js|css|png|jpg|gif|gzip)$ /$1.$3 last;
    }

    location ~* composer\.(?:json|lock) {
        deny all;
    }
    location ~* flexform[^.]*\.xml {
        deny all;
    }
    location ~* locallang[^.]*\.(?:xml|xlf)$ {
        deny all;
    }
    location ~* ext_conf_template\.txt|ext_typoscript_constants\.txt|ext_typoscript_setup\.txt {
        deny all;
    }
    location ~* /.*\.(?:bak|co?nf|cfg|ya?ml|ts|typoscript|tsconfig|dist|fla|in[ci]|log|sh|sql|sqlite)$ {
        deny all;
    }
    location ~ _(?:recycler|temp)_/ {
        deny all;
    }
    location ~ fileadmin/(?:templates)/.*\.(?:txt|ts|typoscript)$ {
        deny all;
    }
    location ~ ^(?:vendor|typo3_src|typo3temp/var) {
        deny all;
    }
    location ~ (?:typo3conf/ext|typo3/sysext|typo3/ext)/[^/]+/(?:Configuration|Resources/Private|Tests?|Documentation|docs?)/ {
        deny all;
    }

    location / {
        try_files $uri $uri/ /index.php$is_args$args;
    }
    location = /typo3 {
        rewrite ^ /typo3/;
    }
    location /typo3/ {
        absolute_redirect off;
        try_files $uri /typo3/index.php$is_args$args;
    }
    location ~ [^/]\.php(/|$) {
        fastcgi_split_path_info ^(.+?\.php)(/.*)$;
        if (!-f $document_root$fastcgi_script_name) {
            return 404;
        }
        fastcgi_buffer_size 32k;
        fastcgi_buffers 8 16k;
        fastcgi_connect_timeout 240s;
        fastcgi_read_timeout 240s;
        fastcgi_send_timeout 240s;

        include              snippets/fastcgi-php.conf;
        fastcgi_pass         unix:/var/run/php/php8.4-fpm.sock;
    }
}
</syntaxhighlight>
